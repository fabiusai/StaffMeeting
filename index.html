<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool per Staff Meeting</title>
    
    <link rel="icon" href="favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- IMPOSTAZIONI GENERALI E COLORI --- */
        :root {
            --brand-blue: #00338D;
            --brand-yellow: #FFD200;
            --light-gray: #f0f1f3;
            --medium-gray: #e1e3e6;
            --dark-gray: #6c757d;
            --text-color: #333;
            --white: #ffffff;
            --border-radius: 6px;
            --success-green: #28a745;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Titillium Web', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        /* --- LAYOUT PRINCIPALE E HEADER --- */
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--brand-blue);
            color: var(--white);
            padding: 20px;
            text-align: center;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            border-bottom: 5px solid var(--brand-yellow);
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        
        /* --- SEZIONI --- */
        .section-card {
            background-color: var(--white);
            padding: 25px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--brand-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--medium-gray);
        }
        
        /* --- BOTTONI --- */
        .btn {
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        .btn-primary {
            background-color: var(--brand-blue);
            color: var(--white);
        }
        .btn-primary:hover {
            background-color: #002266;
        }

        .btn-secondary {
            background-color: var(--brand-yellow);
            color: var(--brand-blue);
        }
        .btn-secondary:hover {
            background-color: #e6bd00;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .controls-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* --- SEZIONE FILTRI --- */
        #filtri-section .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-weight: 600;
            font-size: 0.9rem;
        }
        .filter-group input, .filter-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-family: 'Titillium Web', sans-serif;
        }
        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 20px;
        }

        /* --- SEZIONE CONTENUTI E MODULI --- */
        .module {
            background-color: #fafafa;
            border: 1px solid var(--medium-gray);
            border-left: 5px solid transparent;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            padding: 15px;
            position: relative;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .module.flagged {
            border-left-color: var(--brand-yellow);
            background-color: #fffbef;
        }

        .module.hidden {
            display: none;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--medium-gray);
            flex-wrap: wrap;
            gap: 10px;
            transition: margin 0.4s ease-in-out, padding 0.4s ease-in-out, border-color 0.4s ease-in-out;
        }

        .module.collapsed .module-header {
            border-bottom-color: transparent;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        /* --- MODIFICA 1: Stile Titolo --- */
        .module-title-wrapper {
            flex-grow: 1;
            cursor: pointer;
            display: flex; /* Titolo e meta sulla stessa riga */
            align-items: baseline; /* Allinea la base del testo */
            gap: 15px; /* Spazio tra titolo e meta */
            flex-wrap: wrap; /* Permette al meta di andare a capo su schermi piccoli */
        }

        .module-title {
            font-size: 1.6rem; /* MODIFICATO: Dimensione unificata (da 2.0rem) */
            font-weight: 700;
            color: var(--brand-blue);
            padding: 5px;
            margin: -5px;
            border-radius: var(--border-radius);
            outline: none;
            width: auto; /* MODIFICATO: Permette al meta di stare accanto (da 100%) */
            flex-grow: 1; /* Occupa lo spazio rimanente */
            /* --- MODIFICHE PER RIGA SINGOLA --- */
            white-space: nowrap; /* Forza la riga singola */
            overflow: hidden; /* Nasconde il testo che sborda */
            text-overflow: ellipsis; /* Aggiunge '...' alla fine */
            min-height: auto; /* Sovrascrive il min-height di .editable-cell */
            line-height: 1.2; /* Line height più adatta per un titolo */
        }
        /* --- FINE MODIFICA 1 --- */

        .module-title:focus {
            background-color: var(--white);
            box-shadow: 0 0 0 2px var(--brand-yellow);
            cursor: text;
        }

        /* --- MODIFICA 1: Stile Meta --- */
        .module-meta {
            font-size: 0.8rem;
            color: var(--dark-gray);
            padding-top: 0; /* MODIFICATO: Rimuove spazio sopra (da 5px) */
            flex-shrink: 0; /* Impedisce al meta di restringersi */
        }
        /* --- FINE MODIFICA 1 --- */

        .module-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* --- FIX APRI/CHIUDI RECORD --- */
        .module-content-wrapper {
            display: grid;
            grid-template-rows: 1fr;
            transition: grid-template-rows 0.4s ease-in-out;
        }
        
        .module.collapsed .module-content-wrapper {
            grid-template-rows: 0fr;
        }

        .module-content {
            overflow: hidden;
            min-height: 0;
            display: flex;
            gap: 15px;
            padding-top: 5px;
        }
        
        .module-control-btn {
            background: var(--medium-gray);
            color: var(--dark-gray);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, transform 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .module-control-btn.drag-handle { cursor: grab; }
        .module-control-btn.delete-module-btn { background-color: #fce1e4; color: #dc3545; }
        .module-control-btn:hover { background-color: var(--dark-gray); color: var(--white); }
        .module-control-btn.delete-module-btn:hover { background-color: #dc3545; color: var(--white); }

        .module-control-btn.flag-btn.flagged {
            background-color: var(--brand-yellow);
            color: var(--brand-blue);
        }

        .module.collapsed .toggle-collapse-btn {
            transform: rotate(-180deg);
        }
        
        /* MODIFICA: Dimensione titolo per blocco CHIUSO (come da immagine) */
        .module.collapsed .module-title {
            font-size: 1.6rem; /* MODIFICATO: Dimensione unificata (da 1.7rem) */
        }
        
        /* Vista solo Titoli */
        #modules-container.titles-only-view .module-content-wrapper {
            display: none;
        }
        #modules-container.titles-only-view .module-header {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
         #modules-container.titles-only-view .module {
            padding: 10px 15px;
        }
        #modules-container.titles-only-view .module-title {
            font-size: 1.6rem; /* MODIFICATO: Dimensione unificata (da 1.7rem) */
        }


        .module-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .flex-2 { flex: 2; }
        .flex-1 { flex: 1; }

        .field-container {
            background: var(--white);
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .field-label {
            font-weight: 600;
            padding: 8px 12px;
            background: var(--medium-gray);
            border-bottom: 1px solid #ccc;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            color: var(--brand-blue);
        }

        .editable-cell {
            padding: 12px;
            flex-grow: 1;
            overflow-y: auto;
            /* min-height: 100px; --- RIMOSSO DA QUI --- */
            outline: none;
            /* font-family: Arial, sans-serif; --- RIMOSSO DA QUI --- */
            /* font-size: 11pt; --- RIMOSSO DA QUI --- */
            /* line-height: 1.5; --- RIMOSSO DA QUI --- */
        }
        
        .editable-cell:focus {
            box-shadow: 0 0 0 2px var(--brand-yellow);
        }
        
        /* --- NUOVA REGOLA PER CAMPI DI TESTO --- */
        /* Applica min-height e stili font solo alle celle nei box */
        .field-container .editable-cell {
            min-height: 100px;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
        }
        /* --- FINE NUOVA REGOLA --- */
        
        .column-desc {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 2;
        }
        .column-desc .field-container:first-child { flex-grow: 3; }
        .column-desc .field-container:last-child { flex-grow: 1; }
        .column-desc .field-container:last-child .editable-cell { min-height: 50px; }

        .field-toolbar {
            padding: 5px 12px;
            background: var(--light-gray);
            border-top: 1px solid #ccc;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .tool-icon {
            cursor: pointer;
            color: var(--dark-gray);
            font-size: 16px;
            transition: color 0.2s;
        }

        .tool-icon:hover {
            color: var(--brand-blue);
        }
        
        /* --- RESPONSIVE --- */
        @media (max-width: 1200px) {
            .module-content {
                flex-wrap: wrap;
            }
            .module-content > .module-column {
                min-width: 45%;
            }
        }
        
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .section-title { font-size: 1.5rem; }
            
            .module-content {
                flex-direction: column;
            }
             .module-content > .module-column {
                min-width: 100%;
            }
            .controls-wrapper, .filter-buttons {
                flex-direction: column;
            }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header>
            <h1>Tool per Staff Meeting</h1>
        </header>

        <main>
            <section id="filtri-section" class="section-card">
                <h2 class="section-title">Filtri e Vista</h2>
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-flagged">Stato</label>
                        <select id="filter-flagged">
                            <option value="not-flagged">Solo non flaggati</option>
                            <option value="all">Tutti</option>
                            <option value="flagged">Solo flaggati</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-date-from">Data Da</label>
                        <input type="date" id="filter-date-from">
                    </div>
                    <div class="filter-group">
                        <label for="filter-date-to">Data A</label>
                        <input type="date" id="filter-date-to">
                    </div>
                    <div class="filter-group">
                        <label for="filter-text">Ricerca Testo (es: Poste AND Italiane)</label>
                        <input type="text" id="filter-text" placeholder="Usa AND, OR, NOT...">
                    </div>
                </div>
                <div class="filter-buttons">
                    <button id="apply-filters-btn" class="btn btn-primary"><i class="fas fa-filter"></i> Applica Filtri</button>
                    <button id="reset-filters-btn" class="btn btn-secondary"><i class="fas fa-undo"></i> Resetta Filtri</button>
                    <button id="toggle-view-btn" class="btn btn-secondary"><i class="fas fa-list"></i> Vista Titoli</button>
                    
                    <button id="sort-newest-btn" class="btn btn-secondary"><i class="fas fa-sort-amount-down"></i> Più Recenti</button>
                    <button id="sort-oldest-btn" class="btn btn-secondary"><i class="fas fa-sort-amount-up"></i> Meno Recenti</button>
                    <button id="sort-alpha-btn" class="btn btn-secondary"><i class="fas fa-sort-alpha-down"></i> Alfabetico (A-Z)</button>
                </div>
            </section>

            <section id="contenuti-section" class="section-card">
                <h2 class="section-title">Contenuti</h2>
                <button id="add-module-btn" class="btn btn-primary"><i class="fas fa-plus"></i> Aggiungi Record</button>
                <div id="modules-container">
                    </div>
            </section>

            <section id="gestione-dati-section" class="section-card">
                <h2 class="section-title">Gestione Dati</h2>
                <div class="controls-wrapper">
                    <button id="save-btn" class="btn btn-primary"><i class="fas fa-save"></i> Salva nel Browser</button>
                    <button id="export-btn" class="btn btn-secondary"><i class="fas fa-file-excel"></i> Esporta in Excel</button>
                    <button id="import-btn" class="btn btn-secondary"><i class="fas fa-file-upload"></i> Importa da Excel</button>
                    <input type="file" id="import-file" accept=".xlsx, .xls" style="display: none;">
                    <button id="reset-btn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Resetta Tool</button>
                </div>
            </section>
        </main>
    </div>

    <template id="module-template">
        <div class="module">
            <div class="module-header">
                <div class="module-title-wrapper">
                    <h3 class="module-title editable-cell" contenteditable="true" data-field="tema" placeholder="Inserisci il tema qui..."></h3>
                    <div class="module-meta">
                        Creato il: <span class="module-timestamp"></span>
                    </div>
                </div>
                <div class="module-actions">
                    <button class="module-control-btn toggle-collapse-btn" title="Apri/Chiudi Dettagli"><i class="fas fa-chevron-up"></i></button>
                    <button class="btn btn-secondary btn-copy-ppt"><i class="fas fa-clipboard"></i> Copia per PPT</button>
                    <button class="module-control-btn flag-btn" title="Segna come utilizzato"><i class="far fa-flag"></i></button>
                    <button class="module-control-btn duplicate-module-btn" title="Duplica record"><i class="far fa-clone"></i></button>
                    <button class="module-control-btn drag-handle" title="Trascina per riordinare"><i class="fas fa-grip-vertical"></i></button>
                    <button class="module-control-btn delete-module-btn" title="Elimina record"><i class="fas fa-times"></i></button>
                </div>
            </div>
            
            <div class="module-content-wrapper">
                <div class="module-content">
                    <div class="column-desc">
                        <div class="field-container">
                            <div class="field-label">Descrizione estesa</div>
                            <div class="editable-cell" contenteditable="true" data-field="desc-estesa"></div>
                             <div class="field-toolbar">
                                <i class="fas fa-copy tool-icon" title="Copia testo" data-action="copy"></i>
                                <i class="fas fa-font tool-icon" title="Testo selezionato in MAIUSCOLO" data-action="uppercase"></i>
                                <i class="fas fa-italic tool-icon" style="text-transform: lowercase; font-style: normal;" title="Testo selezionato in minuscolo" data-action="lowercase">a</i>
                                <i class="fas fa-heading tool-icon" title="Iniziali Maiuscole" data-action="capitalize"></i>
                            </div>
                        </div>
                        <div class="field-container">
                            <div class="field-label">Descrizione sintetica</div>
                            <div class="editable-cell" contenteditable="true" data-field="desc-sintetica"></div>
                             <div class="field-toolbar">
                                <i class="fas fa-copy tool-icon" title="Copia testo" data-action="copy"></i>
                                 <i class="fas fa-font tool-icon" title="Testo selezionato in MAIUSCOLO" data-action="uppercase"></i>
                                <i class="fas fa-italic tool-icon" style="text-transform: lowercase; font-style: normal;" title="Testo selezionato in minuscolo" data-action="lowercase">a</i>
                                <i class="fas fa-heading tool-icon" title="Iniziali Maiuscole" data-action="capitalize"></i>
                            </div>
                        </div>
                    </div>

                    <div class="module-column flex-1">
                         <div class="field-container">
                            <div class="field-label">Prossimi passi</div>
                            <div class="editable-cell" contenteditable="true" data-field="prossimi-passi"></div>
                             <div class="field-toolbar">
                                <i class="fas fa-copy tool-icon" title="Copia testo" data-action="copy"></i>
                                 <i class="fas fa-font tool-icon" title="Testo selezionato in MAIUSCOLO" data-action="uppercase"></i>
                                <i class="fas fa-italic tool-icon" style="text-transform: lowercase; font-style: normal;" title="Testo selezionato in minuscolo" data-action="lowercase">a</i>
                                <i class="fas fa-heading tool-icon" title="Iniziali Maiuscole" data-action="capitalize"></i>
                            </div>
                        </div>
                    </div>

                    <div class="module-column flex-1">
                        <div class="field-container">
                            <div class="field-label">Strutture</div>
                            <div class="editable-cell" contenteditable="true" data-field="strutture"></div>
                             <div class="field-toolbar">
                                <i class="fas fa-copy tool-icon" title="Copia testo" data-action="copy"></i>
                                 <i class="fas fa-font tool-icon" title="Testo selezionato in MAIUSCOLO" data-action="uppercase"></i>
                                <i class="fas fa-italic tool-icon" style="text-transform: lowercase; font-style: normal;" title="Testo selezionato in minuscolo" data-action="lowercase">a</i>
                                <i class="fas fa-heading tool-icon" title="Iniziali Maiuscole" data-action="capitalize"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ELEMENTI DEL DOM ---
        const modulesContainer = document.getElementById('modules-container');
        const moduleTemplate = document.getElementById('module-template');
        
        // Bottoni Contenuti
        const addModuleBtn = document.getElementById('add-module-btn');
        
        // Bottoni Gestione Dati
        const saveBtn = document.getElementById('save-btn');
        const exportBtn = document.getElementById('export-btn');
        const importBtn = document.getElementById('import-btn');
        const importFileInput = document.getElementById('import-file');
        const resetBtn = document.getElementById('reset-btn');

        // Controlli Filtri
        const filterFlagged = document.getElementById('filter-flagged');
        const filterDateFrom = document.getElementById('filter-date-from');
        const filterDateTo = document.getElementById('filter-date-to');
        const filterText = document.getElementById('filter-text');
        const applyFiltersBtn = document.getElementById('apply-filters-btn');
        const resetFiltersBtn = document.getElementById('reset-filters-btn');
        const toggleViewBtn = document.getElementById('toggle-view-btn');

        // MODIFICA: Bottoni Ordinamento
        const sortNewestBtn = document.getElementById('sort-newest-btn');
        const sortOldestBtn = document.getElementById('sort-oldest-btn');
        const sortAlphaBtn = document.getElementById('sort-alpha-btn');


        // --- INIZIALIZZAZIONE ---
        new Sortable(modulesContainer, {
            animation: 150,
            handle: '.drag-handle',
        });

        // --- FUNZIONI PRINCIPALI ---

        /**
         * Crea un nuovo modulo e lo aggiunge al container.
         * @param {object} data - Dati opzionali per popolare il modulo.
         * @param {boolean} prepend - Se true, aggiunge il modulo all'inizio (richiesta 2).
         */
        const createModule = (data = {}, prepend = false) => { // MODIFICATO per richiesta 2
            const moduleClone = moduleTemplate.content.cloneNode(true);
            const moduleElement = moduleClone.querySelector('.module');
            
            moduleElement.dataset.id = data.id || `module-${Date.now()}`;
            // Se esiste un timestamp nei dati (es. dal salvataggio), usa quello, altrimenti creane uno nuovo.
            moduleElement.dataset.timestamp = data.timestamp || new Date().toISOString();
            moduleElement.dataset.flagged = data.flagged || 'false';
            
            const fields = moduleElement.querySelectorAll('.editable-cell');
            fields.forEach(field => {
                const fieldName = field.dataset.field;
                if (data[fieldName]) {
                    field.innerHTML = data[fieldName];
                }
            });

            updateModuleVisuals(moduleElement);
            
            // MODIFICATO per richiesta 2
            if (prepend) {
                modulesContainer.prepend(moduleClone); // Aggiunge in cima
            } else {
                modulesContainer.appendChild(moduleClone); // Aggiunge in fondo (per caricamento)
            }
        };

        const updateModuleVisuals = (moduleElement) => {
            const timestampEl = moduleElement.querySelector('.module-timestamp');
            const date = new Date(moduleElement.dataset.timestamp);
            timestampEl.textContent = date.toLocaleString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });

            const isFlagged = moduleElement.dataset.flagged === 'true';
            moduleElement.classList.toggle('flagged', isFlagged);
            const flagBtn = moduleElement.querySelector('.flag-btn');
            const flagIcon = flagBtn.querySelector('i');
            flagBtn.classList.toggle('flagged', isFlagged);
            flagIcon.className = isFlagged ? 'fas fa-flag' : 'far fa-flag';
            flagBtn.title = isFlagged ? 'Rimuovi flag' : 'Segna come utilizzato';
        };

        // NOTA: La funzione 'updateTimestamp' esiste ancora, ma non viene
        // più chiamata dall'evento 'input'. Potrebbe essere usata in futuro
        // per un bottone "aggiorna data manually", ma al momento è inattiva.
        const updateTimestamp = (moduleElement) => {
             moduleElement.dataset.timestamp = new Date().toISOString();
             updateModuleVisuals(moduleElement);
        }

        const showButtonFeedback = (button, message, isSuccess = true, duration = 1500) => {
            const originalContent = button.innerHTML;
            button.innerHTML = message;
            button.disabled = true;
            
            const originalBg = button.style.backgroundColor;
            if(isSuccess) {
                button.style.backgroundColor = 'var(--success-green)';
            }

            setTimeout(() => {
                button.innerHTML = originalContent;
                button.disabled = false;
                button.style.backgroundColor = originalBg;
            }, duration);
        };

        // --- GESTIONE EVENTI ---

        modulesContainer.addEventListener('paste', (e) => {
            if (e.target.classList.contains('editable-cell')) {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                document.execCommand('insertText', false, text);
            }
        });

        modulesContainer.addEventListener('click', async (e) => {
            const moduleElement = e.target.closest('.module');
            if (!moduleElement) return;

            // Logica per flaggare
            if (e.target.closest('.flag-btn')) {
                const flagBtn = e.target.closest('.flag-btn');
                const isFlagged = moduleElement.dataset.flagged === 'true';
                moduleElement.dataset.flagged = !isFlagged;
                updateModuleVisuals(moduleElement);
                // Non ritorna, così il click può propagare se necessario
            }

            const titleWrapper = e.target.closest('.module-title-wrapper');
            const collapseButton = e.target.closest('.toggle-collapse-btn');
            const titleElement = moduleElement.querySelector('.module-title');

            // Impedisce di chiudere il modulo se si clicca su un bottone nell'header (es. flag)
            if (e.target.closest('.module-control-btn') || e.target.closest('.btn-copy-ppt')) {
                 if (collapseButton) {
                    moduleElement.classList.toggle('collapsed');
                 }
                 // Non continuare se si clicca su un'azione
            } else if (titleWrapper && document.activeElement !== titleElement) {
                moduleElement.classList.toggle('collapsed');
            }


            if (e.target.closest('.delete-module-btn')) {
                if(confirm('Sei sicuro di voler eliminare questo record?')) {
                    moduleElement.remove();
                }
                return;
            }

            // --- NUOVA LOGICA DUPLICA ---
            if (e.target.closest('.duplicate-module-btn')) {
                const dataToDuplicate = {
                    flagged: moduleElement.dataset.flagged === 'true',
                };
                
                // 1. Raccoglie i dati dal modulo corrente
                moduleElement.querySelectorAll('.editable-cell').forEach(cell => {
                    const fieldName = cell.dataset.field;
                    dataToDuplicate[fieldName] = cell.innerHTML;
                });
                
                // 2. Aggiunge "(Copia)" al tema per distinguerlo
                if (dataToDuplicate['tema']) {
                    dataToDuplicate['tema'] += " (Copia)";
                } else {
                    dataToDuplicate['tema'] = "Copia";
                }
                
                // 3. Crea il nuovo modulo (che genera nuovo ID e timestamp)
                //    'true' lo prepende (mette in cima), come da richiesta precedente
                createModule(dataToDuplicate, true); 
                return;
            }
            // --- FINE NUOVA LOGICA ---

            // --- LOGICA DI COPIA ---
            if (e.target.closest('.btn-copy-ppt')) {
                const button = e.target.closest('.btn-copy-ppt');
                const fieldsToCopy = ['tema', 'desc-estesa', 'prossimi-passi', 'strutture'];
                
                const getStyledHtmlForField = (fieldName, text) => {
                    const commonStyle = "font-family: Arial, sans-serif; font-size: 11pt; margin: 0; padding: 0;";
                    const blackColor = "color: #000000;";
                    const themeColor = "color: #2a4979;"; 
                    const cleanedText = text.trim();
                    
                    const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

                    switch(fieldName) {
                        case 'tema':
                            return `<p style="${commonStyle} ${themeColor} font-weight: bold;">${escapeHtml(cleanedText).replace(/\n/g, '<br>')}</p>`;
                        
                        case 'desc-estesa':
                             if (!cleanedText) return `<p></p>`;
                            return `<p style="${commonStyle} ${blackColor}">${escapeHtml(cleanedText).replace(/\n/g, '<br>')}</p>`;

                        case 'prossimi-passi':
                        case 'strutture':
                            return `<p style="${commonStyle} ${blackColor}">${escapeHtml(cleanedText).replace(/\n/g, '<br>')}</p>`;
                        
                        default:
                            return escapeHtml(cleanedText).replace(/\n/g, '<br>');
                    }
                };

                const htmlCells = fieldsToCopy.map(fieldName => {
                    const field = moduleElement.querySelector(`.editable-cell[data-field="${fieldName}"]`);
                    const text = field ? field.innerText : '';
                    const styledHtml = getStyledHtmlForField(fieldName, text);
                    return `<td style="vertical-align: top;">${styledHtml}</td>`;
                }).join('');

                const htmlString = `<table><tbody><tr>${htmlCells}</tr></tbody></table>`;

                const textPlain = fieldsToCopy.map(fieldName => {
                    const field = moduleElement.querySelector(`.editable-cell[data-field="${fieldName}"]`);
                    return field ? field.innerText : '';
                }).join('\t');
                
                try {
                    const blobHtml = new Blob([htmlString], { type: 'text/html' });
                    const blobText = new Blob([textPlain], { type: 'text/plain' });
                    const data = [new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText })];
                    
                    await navigator.clipboard.write(data);
                    showButtonFeedback(button, 'Copiato! <i class="fas fa-check"></i>');
                } catch(err) {
                    showButtonFeedback(button, 'Errore', false);
                }
                return;
            }

            const toolIcon = e.target.closest('.tool-icon');
            if (toolIcon) {
                const action = toolIcon.dataset.action;
                const editableCell = toolIcon.closest('.field-container').querySelector('.editable-cell');
                editableCell.focus();

                const transformSelection = (transformFn) => {
                    const selection = window.getSelection();
                    if (selection.rangeCount > 0) {
                        const range = selection.getRangeAt(0);
                        const selectedText = range.toString();
                        if (selectedText) {
                            range.deleteContents();
                            range.insertNode(document.createTextNode(transformFn(selectedText)));
                        }
                    }
                };

                switch (action) {
                    case 'copy':
                        navigator.clipboard.writeText(editableCell.innerText).then(() => {
                           toolIcon.classList.replace('fa-copy', 'fa-check');
                           setTimeout(() => toolIcon.classList.replace('fa-check', 'fa-copy'), 1500);
                        });
                        break;
                    case 'uppercase': transformSelection(text => text.toUpperCase()); break;
                    case 'lowercase': transformSelection(text => text.toLowerCase()); break;
                    case 'capitalize': transformSelection(text => text.toLowerCase().replace(/\b\w/g, char => char.toUpperCase())); break;
                }
            }
        });
        
        
        // --- MODIFICA APPLICATA ---
        // Il blocco 'modulesContainer.addEventListener('input', ...)' è stato rimosso
        // per impedire l'aggiornamento della data durante la modifica.

        // --- GESTIONE DATI (SALVATAGGIO, CARICAMENTO, ETC) ---

        saveBtn.addEventListener('click', () => {
            const modulesData = [];
            modulesContainer.querySelectorAll('.module').forEach(module => {
                const moduleData = {
                    id: module.dataset.id,
                    timestamp: module.dataset.timestamp,
                    flagged: module.dataset.flagged === 'true',
                };
                module.querySelectorAll('.editable-cell').forEach(cell => {
                    const fieldName = cell.dataset.field;
                    moduleData[fieldName] = cell.innerHTML;
                });
                modulesData.push(moduleData);
            });
            
            const dataToSave = { modules: modulesData };
            localStorage.setItem('staffMeetingDataV2', JSON.stringify(dataToSave));
            showButtonFeedback(saveBtn, 'Salvato! <i class="fas fa-check"></i>');
        });

        const loadData = () => {
            const savedData = localStorage.getItem('staffMeetingDataV2');
            if (savedData) {
                const data = JSON.parse(savedData);
                modulesContainer.innerHTML = '';
                if (data.modules) {
                    
                    // --- ORDINAMENTO DI DEFAULT (PIU' RECENTE -> PIU' VECCHIO) ---
                    data.modules.sort((a, b) => {
                        const dateA = new Date(a.timestamp || 0);
                        const dateB = new Date(b.timestamp || 0);
                        return dateB - dateA; // Ordina dal più recente al più vecchio
                    });
                    
                    // Aggiunge i moduli in ordine (createModule userà appendChild di default)
                    data.modules.forEach(moduleData => createModule(moduleData, false));
                }
            }
        };

        exportBtn.addEventListener('click', () => {
            showButtonFeedback(exportBtn, 'Esporto...', true, 3000);
            const dataForExport = [];
            
            // Per l'export, usa i moduli visibili nell'ordine in cui sono visualizzati
            const modulesToExport = Array.from(modulesContainer.querySelectorAll('.module:not(.hidden)'));

            // NOTA: l'export rispetterà l'ordinamento attualmente visibile (sia da drag-and-drop che da bottoni di sort)
            
            modulesToExport.forEach(module => {
                const row = {};
                row['Flagged'] = module.dataset.flagged === 'true' ? 'Sì' : 'No';
                row['Data Creazione'] = new Date(module.dataset.timestamp).toLocaleString('it-IT');
                
                module.querySelectorAll('.editable-cell').forEach(cell => {
                    const label = cell.dataset.field === 'tema' 
                        ? 'Tema' 
                        : cell.closest('.field-container').querySelector('.field-label').innerText;
                    row[label] = cell.innerText; // Usa innerText per un Excel pulito (senza HTML)
                });
                dataForExport.push(row);
            });

            if (dataForExport.length === 0) {
                showButtonFeedback(exportBtn, 'Nessun dato', false);
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(dataForExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Staff Meeting');
            const fileName = `Staff_Meeting_Export_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        });

        importBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showButtonFeedback(importBtn, 'Carico...', true, 3000);

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (json.length > 0) {
                        if (confirm("L'importazione aggiungerà i nuovi record a quelli esistenti (in cima all'elenco). Continuare?")) {
                            json.forEach(row => {
                                const processText = (text) => (text || '').toString().replace(/\n/g, '<br>');
                                
                                // Cerca di leggere una data, altrimenti ne crea una nuova
                                let importTimestamp = new Date().toISOString();
                                const dateString = row['Data Creazione'] || row['Last Update'];
                                if (dateString) {
                                    try {
                                        // Tenta di parsare la data dal formato it-IT
                                        const parts = dateString.split(', ')[0].split('/');
                                        const timeParts = (dateString.split(', ')[1] || '00:00:00').split(':');
                                        const isoDate = `${parts[2]}-${parts[1]}-${parts[0]}T${timeParts[0]}:${timeParts[1]}:${timeParts[2]}`;
                                        const parsedDate = new Date(isoDate);
                                        if (!isNaN(parsedDate)) {
                                            importTimestamp = parsedDate.toISOString();
                                        }
                                    } catch (err) {
                                        // Ignora l'errore, userà il timestamp corrente
                                    }
                                }

                                const moduleData = {
                                    'tema': processText(row['Tema']),
                                    'desc-estesa': processText(row['Descrizione estesa']),
                                    'desc-sintetica': processText(row['Descrizione sintetica']),
                                    'prossimi-passi': processText(row['Prossimi passi']),
                                    'strutture': processText(row['Strutture']),
                                    'flagged': (row['Flagged'] || '').toString().toLowerCase() === 'sì',
                                    'timestamp': importTimestamp // Aggiunge il timestamp letto o nuovo
                                };
                                // MODIFICATO per richiesta 2: Aggiunge in cima
                                createModule(moduleData, true); 
                            });
                        }
                    } else { alert("Il file Excel sembra essere vuoto o non valido."); }
                } catch (error) {
                    console.error("Errore importazione:", error);
                    alert("Errore durante la lettura del file. Assicurati che sia un file Excel valido.");
                } finally {
                    importFileInput.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        resetBtn.addEventListener('click', () => {
            if (confirm("Sei sicuro di voler resettare tutti i dati? L'operazione non è reversibile.")) {
                localStorage.removeItem('staffMeetingDataV2');
                modulesContainer.innerHTML = '';
                showButtonFeedback(resetBtn, 'Resettato <i class="fas fa-check"></i>');
            }
        });

        // MODIFICATO per richiesta 2: Aggiunge in cima
        addModuleBtn.addEventListener('click', () => createModule({}, true));


        // --- MODIFICA: LOGICA DI RIORDINAMENTO ---

        /**
         * Riordina i moduli nel DOM in base a una funzione di comparazione.
         * @param {function} sortFunction - La funzione (a, b) => ...
         */
        const reorderModules = (sortFunction) => {
            const modules = Array.from(modulesContainer.querySelectorAll('.module'));
            
            modules.sort(sortFunction);
            
            // Riassegna gli elementi al container nell'ordine corretto
            modules.forEach(module => modulesContainer.appendChild(module));
        };

        // Funzioni di comparazione per l'ordinamento
        const sortByNewest = (a, b) => {
            const dateA = new Date(a.dataset.timestamp || 0);
            const dateB = new Date(b.dataset.timestamp || 0);
            return dateB - dateA; // Più recente prima
        };

        const sortByOldest = (a, b) => {
            const dateA = new Date(a.dataset.timestamp || 0);
            const dateB = new Date(b.dataset.timestamp || 0);
            return dateA - dateB; // Meno recente prima
        };

        const sortByAlphabetical = (a, b) => {
            const titleA = a.querySelector('.module-title')?.innerText.trim().toLowerCase() || '';
            const titleB = b.querySelector('.module-title')?.innerText.trim().toLowerCase() || '';
            return titleA.localeCompare(titleB); // A-Z
        };

        // Aggiungi gli event listener ai nuovi bottoni
        sortNewestBtn.addEventListener('click', () => reorderModules(sortByNewest));
        sortOldestBtn.addEventListener('click', () => reorderModules(sortByOldest));
        sortAlphaBtn.addEventListener('click', () => reorderModules(sortByAlphabetical));


        // --- LOGICA FILTRI E VISTA ---
        
        const applyFilters = () => {
            const modules = modulesContainer.querySelectorAll('.module');
            const flagValue = filterFlagged.value;
            const dateFrom = filterDateFrom.value ? new Date(filterDateFrom.value).setHours(0,0,0,0) : null;
            const dateTo = filterDateTo.value ? new Date(filterDateTo.value).setHours(23,59,59,999) : null;
            const searchText = filterText.value.trim().toLowerCase();
            
            modules.forEach(module => {
                let isVisible = true;

                if (flagValue !== 'all') {
                    const isFlagged = module.dataset.flagged === 'true';
                    if ((flagValue === 'flagged' && !isFlagged) || (flagValue === 'not-flagged' && isFlagged)) {
                        isVisible = false;
                    }
                }
                
                if(isVisible && (dateFrom || dateTo)) {
                    const moduleDate = new Date(module.dataset.timestamp).getTime();
                    if((dateFrom && moduleDate < dateFrom) || (dateTo && moduleDate > dateTo)) {
                       isVisible = false;
                    }
                }
                
                if (isVisible && searchText) {
                    const moduleText = Array.from(module.querySelectorAll('.editable-cell')).map(c => c.innerText).join(' ').toLowerCase();
                    const hasOR = searchText.includes(' or ');
                    const hasNOT = searchText.includes(' not ');

                    if (hasOR) {
                        // Supporta termini multipli con OR
                        const terms = searchText.split(' or ').map(t => t.trim()).filter(t => t.length > 0);
                        isVisible = terms.some(term => moduleText.includes(term));
                    } else {
                        // Gestisce AND e NOT insieme
                        const terms = searchText.split(' ').map(t => t.trim()).filter(t => t.length > 0);
                        let mustContain = [];
                        let mustNotContain = [];

                        terms.forEach(term => {
                            if (term.startsWith('not:')) {
                                mustNotContain.push(term.substring(4));
                            } else if (term.startsWith('not ')) { // Meno probabile data la logica precedente, ma sicuro
                                mustNotContain.push(term.substring(4));
                            } else if (term !== 'and') { // Ignora 'and'
                                mustContain.push(term);
                            }
                        });
                        
                        // Se non ci sono 'not:', usa la vecchia logica AND/NOT
                        if (mustNotContain.length === 0 && hasNOT) {
                             const parts = searchText.split(' not ');
                             mustContain = parts[0].trim().split(' and ').map(t => t.trim());
                             mustNotContain = parts.slice(1).map(t => t.trim());
                        } else if (mustNotContain.length === 0 && !hasNOT) {
                             mustContain = searchText.split(' and ').map(t => t.trim());
                        }

                        // Controlla la visibilità
                        const matchesAll = mustContain.length === 0 || mustContain.every(term => moduleText.includes(term));
                        const matchesNone = mustNotContain.length === 0 || !mustNotContain.some(term => term.length > 0 && moduleText.includes(term));
                        
                        isVisible = matchesAll && matchesNone;
                    }
                }

                module.classList.toggle('hidden', !isVisible);
            });
        };
        
        toggleViewBtn.addEventListener('click', () => {
            modulesContainer.classList.toggle('titles-only-view');
            const isTitlesView = modulesContainer.classList.contains('titles-only-view');
            toggleViewBtn.innerHTML = isTitlesView 
                ? '<i class="fas fa-expand-arrows-alt"></i> Vista Dettagliata' 
                : '<i class="fas fa-list"></i> Vista Titoli';
        });

        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', () => {
            filterFlagged.value = 'not-flagged';
            filterDateFrom.value = '';
            filterDateTo.value = '';
            filterText.value = '';
            applyFilters();
        });

        // --- CARICAMENTO INIZIALE ---
        loadData();
        applyFilters(); // Applica il filtro di default ("solo non flaggati") al caricamento
    });
    </script>
</body>
</html>
